---
title:  "Helper functions to interact with common map APIs"
author: "IFPRI/HarvestChoice"
date:   "Nov. 2016. Last updated on `r Sys.Date()`"
output:
  html_document:
    fig_height: 5
    toc: true
    toc_float: true    
    fig_caption: true    
---


The objective is to compare travel times generated by Google, HERE, OSM, and other services against HarvestChoice models. We'll use household locations from the latest round of the Tanzania LSMS-ISA to test the performance of these tools.


```{r setup, message=FALSE}

library(data.table)
library(foreign)
library(raster)
library(tmap)
library(httr)
library(jsonlite)
library(listviewer) # pretty print complex lists
library(pander)     # pretty print R objects to HTML

setwd("~/Projects/hc-shiny/geospat")

# Load sample data from the work we did on Beliyou's resilience paper
load("./tmp/resilience.RData")

# Keep only the data we need here (`gps` contains household GPS coordinates)
rm(list=ls()[!ls() %in% c("svy", "gps", "g2", "api_key")])

# What survey panels do we have?
pander(gps[, .N, by=svyCode])

# Keep only tza2012
gps <- gps[svyCode=="tza2012"]

# Remove observations with no GPS, if any
gps <- gps[!is.na(X_mod)]

# Show first 5 rows
pander(gps[1:5])


```

# Google Distance Matrix API

This tool is documented at https://developers.google.com/maps/documentation/distance-matrix/start. Requires a unique API key. 

Request limits for the free version:
* entries per day: 2,500	
* requests per 100 seconds: 10,000	
* requests per 100 seconds per user: Unlimited
* results are in seconds


```{r}

# Helper - Google maps distance matrix API
gmapsapi <- function(o, d) {
  url <- "https://maps.googleapis.com/maps/api/distancematrix/json"
  out <- GET(url, query=list(origins=o, destinations=d, mode="driving", key=api_key))
  out <- fromJSON(content(out, as="text"))
  # Keep `time` only (in seconds)
  return(out$rows$elements[[1]]$duration$value)
}

# Run a test to see how the API response is constructed
jsonedit(bib[1][[1:2]]) %>% je_simple_style()

# Init a results matrix
tt <- matrix(as.numeric(NA), nrow=nrow(gps), ncol=nrow(gps))
dimnames(tt) <- list(gps$hhid, gps$hhid)

# Choose how many requests we sent at a time
N <- 200

# Hit the API and collect responses
for (i in 1:nrow(gps)[1]) {
  intervals <- seq(i, nrow(gps), N)
  for (j in 1:length(intervals)) {
    f <- intervals[j]
    t <- intervals[j+1]-1
    tt[i, f:t] <- gmapsapi(
      gps[i, paste(Y_mod, X_mod, sep=",")],
      gps[f:t, paste(Y_mod, X_mod, sep=",", collapse="|")])
  }
}

# Show first 20 results
pander(tt[1, 1:20])


#=> works but returns quite a few NAs


# Map these results

tm_shape(World) + tm_polygons() +
  tm_shape(l[1:2297,], is.master=T) + 
  tm_lines(col="time", colorNA="white", lwd=.4, alpha=.4, title.col="travel (hours)") +
  tm_style_grey()

```



# HERE Routing API

# TODO OSM Routing API



```{r}

# Save workspace
save.image("./tmp/mapsapi.RData")

```





